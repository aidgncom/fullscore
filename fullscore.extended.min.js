const BEAT={TIC:100,TOK:{P:"!",E:"*",T:"~",A:"/",L:"-"},MAP:{P:{},E:{}}};const RHYTHM={HIT:"/rhythm",ECO:["/rhythm/echo"],TIC:100,TAP:3,THR:1,KEY:8,AGE:259200,MAX:7,CAP:3500,DEL:1,REF:{},ADD:{TAB:!0,SCR:!1,SPA:!1,POW:!1}};class Beat{constructor(){this.t=[],this.table={},this.i={pages:{...BEAT.MAP.P},elements:{...BEAT.MAP.E}},this.h=Date.now()}time(){const t=Date.now(),i=(t-this.h)/BEAT.TIC|0;i>0&&(this.t.push(BEAT.TOK.T+i),this.h=t)}o(t){const i=this.t.length;if(i>1&&this.t[i-1].startsWith(BEAT.TOK.T)){const s=this.t[i-1].substring(1),e=this.t[i-2];if(e.endsWith(t))return this.t[i-2]=e.substring(0,e.length-t.length)+BEAT.TOK.A+s+t,void this.t.pop()}this.t.push(t)}page(t){if(this.time(),this.i.pages[t])return this.t.push(BEAT.TOK.P+this.i.pages[t]);let i=5381;for(let c=0;c<t.length;c++)i=(i<<5)+i+t.charCodeAt(c);const s=t.length<=7?3:t.length<=14?4:5;let e="",h=Math.abs(i);for(let c=0;c<s;c++)e+="0123456789abcdefghijklmnopqrstuvwxyz"[h%36],h=Math.floor(h/36);let o=BEAT.TOK.P+e,n="";for(;this.table[o]&&this.table[o]!==t;)n+=BEAT.TOK.L,o=BEAT.TOK.P+n+e;this.table[o]=t,this.t.push(o)}element(t){if(!t||3===t.nodeType&&!(t=t.parentElement))return;this.time();let i=t.id&&this.i.elements["#"+t.id]?"#"+t.id:null;!i&&"string"==typeof t.className&&t.className&&(i=t.className.trim().split(/\s+/).map(t=>"."+t).find(t=>this.i.elements[t]));const s=!i&&"A"===t.tagName&&t.href&&t.getAttribute("href");if(s&&this.i.elements[s]&&(i=s),i)return this.o(BEAT.TOK.E+this.i.elements[i]);let e=0,h=t;for(;h&&h!==document.body;)e++,h=h.parentElement;const o=t.tagName.toLowerCase();let n=1,c=t.previousElementSibling;for(;c;)c.tagName.toLowerCase()===o&&n++,c=c.previousElementSibling;const r=e+o+n;this.o(BEAT.TOK.E+(this.i.elements["*"+r]||r))}l(){return this.t.join("")}}class Rhythm{constructor(){this.u="; Path=/; Max-Age="+RHYTHM.AGE+"; SameSite=Lax"+("https:"===location.protocol?"; Secure":"");const t=()=>{let t="";for(let i=0;i<RHYTHM.KEY;i++)t+="0123456789abcdefghijklmnopqrstuvwxyz"[36*Math.random()|0];document.cookie="score=0000000000_"+Math.floor(Date.now()/RHYTHM.TIC)+"_"+t+"___; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":"")};if(this.get("score")||(this.m(),this._(),t()),this.session(),"ontouchstart"in window||navigator.maxTouchPoints>0){const t=new Set;let i=!1;document.addEventListener("touchstart",()=>{i=!1;for(const i of t)document.removeEventListener("click",i,!0);t.clear()},{capture:!0,passive:!0}),document.addEventListener("touchmove",()=>i=!0,{capture:!0,passive:!0}),document.addEventListener("touchcancel",()=>i=!0,{capture:!0,passive:!0}),document.addEventListener("touchend",s=>{if(i||!s.changedTouches?.[0])return;let e=!0;const h=i=>{e&&i.isTrusted&&(i.preventDefault(),i.stopImmediatePropagation(),e=!1,document.removeEventListener("click",h,!0),t.delete(h))};t.add(h),document.addEventListener("click",h,{capture:!0});let o=document.elementFromPoint(s.changedTouches[0].clientX,s.changedTouches[0].clientY);const n=o?.closest("label");if(o=n?.control||n?.querySelector("input,textarea,select,button")||o,this.click(o),o)for(let t=0;t<8;t++){if("function"==typeof o.click){o.click();break}if(o.onclick){o.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0}));break}if(!(o=o.parentElement))break}},{capture:!0,passive:!0})}else{let t=!1;document.addEventListener("mousedown",()=>t=!1,{capture:!0}),document.addEventListener("keydown",i=>!i.repeat&&("Enter"===i.key||" "===i.key)&&(t=!1),{capture:!0}),document.addEventListener("click",i=>{if(t)return;t=!0;let s=i.target.closest("label")?.control||i.target;this.click(s)},{capture:!0})}this.scrolling=!1,document.addEventListener("scroll",()=>{this.data||this.session(),this.scrolling||(this.scrolling=!0,this.data.p++,this.save()),clearTimeout(this.s),this.s=setTimeout(()=>{RHYTHM.ADD.SCR&&(this.v.time(),this.v.t.push("^"+Math.round(window.scrollY))),this.scrolling=!1},150)},{capture:!0,passive:!0}),RHYTHM.ADD.SPA&&this.k(),document.addEventListener("visibilitychange",()=>{const i=this.get(window.name),s=/mobi|android|tablet|ipad|iphone/i.test(navigator.userAgent);if("hidden"===document.visibilityState){if(RHYTHM.ADD.POW&&/rhythm_\d+=/.test(document.cookie))return this._();s&&i&&"0"===i[0]&&(document.cookie=window.name+"=1"+i.slice(1)+this.u),setTimeout(()=>!/rhythm_\d+=0/.test(document.cookie)&&this.blur&&this._(!0),1)}else s&&i&&"1"===i[0]&&(document.cookie=window.name+"=0"+i.slice(1)+this.u),!this.get("score")&&(t(),this.session(!0)),this.v.h=Date.now()});const i=()=>{const t=this.get(window.name);t&&"0"===t[0]&&(document.cookie=window.name+"=1"+t.slice(1)+this.u)};window.addEventListener("blur",()=>"hidden"===document.visibilityState&&(i(),this.blur=!0,setTimeout(()=>this.blur=!1,17))),window.addEventListener("pagehide",t=>!t.persisted&&(RHYTHM.ADD.POW?this._(!0):(i(),setTimeout(()=>!/rhythm_\d+=0/.test(document.cookie)&&this._(!0),1))))}get(t){const i="; "+document.cookie+";",s=i.indexOf("; "+t+"=");return s<0?null:i.slice(s+t.length+3,i.indexOf(";",s+t.length+3))}m(){for(let t,i=1;i<=RHYTHM.MAX;i++)t="rhythm_"+i,"2"===this.get(t)?.[0]&&(document.cookie=t+"=; Max-Age=0; Path=/");this.data=null,this.v=null,window.name=""}_(t=!1){t&&(document.cookie="score=; Max-Age=0; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":""));const i=document.cookie.match(/rhythm_\d+=[^;]*/g);if(i){const t=[];for(let s=0;s<i.length;s++){const e=i[s].replace(/=./,"=2"),h=e.split("=")[0];+((this.get(h)||e).split("_")[6]||0)<RHYTHM.DEL?document.cookie=h+"=; Max-Age=0; Path=/":(document.cookie=e+this.u,t.push(e))}if(t.length){const i=t.join("");for(const t of RHYTHM.ECO){const s="h"===t[0]?t:location.origin+t;navigator.sendBeacon(s,i)||fetch(s,{method:"POST",body:i,keepalive:!0}).catch(()=>{})}}this.m()}}session(t=!1){this.score=this.get("score");const i=this.score.split("_");if(this.time=+i[1],this.key=i[2],!t&&window.name.startsWith("rhythm_")){const t=this.get(window.name);if(t){const i=t.split("_"),s=i.slice(8).join("_");return this.data={name:window.name,time:+i[1],key:i[2],device:+i[3],referrer:+i[4],p:+i[5],S:+i[6]},this.v=new Beat,s&&(this.v.t=[s],this.v.h=Date.now()),this.v.page(location.pathname),this.save()}window.name=""}let s=null;for(let c=1;c<=RHYTHM.MAX;c++)if(!this.get("rhythm_"+c)){s="rhythm_"+c;break}if(!s){this._(),this.data=null;const t=Math.floor(Date.now()/RHYTHM.TIC);this.score=this.score.split("_")[0]+"_"+t+"_"+this.key+"___",document.cookie="score="+this.score+"; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":""),this.time=t,s="rhythm_1"}window.name=s;const e=navigator.userAgent,h=document.referrer,o=h?.match(/^https?:\/\/([^\/]+)/)?.[1]||"";let n=h?o===location.hostname?1:2:0;if(2===n&&o)for(const c in RHYTHM.REF)if(o===c||o.endsWith("."+c)){n=RHYTHM.REF[c];break}this.data={name:s,time:this.time,key:this.key,device:/ipad|tablet|silk/i.test(e)||/android/i.test(e)&&!/mobi/i.test(e)?2:/mobi|iphone/i.test(e)?1:0,referrer:n,p:0,S:0},this.v=new Beat,this.v.page(location.pathname),this.save(!0)}save(t=!1){const i=this.get("score")||this.score;if(!t&&+i.split("_",2)[1]!==+this.score.split("_",2)[1])return this.score=i,this.data=null,void this.session(!0);const s=window.name.slice(7),e=i.split("___"),h=e[1]||"";if(RHYTHM.ADD.TAB&&!RHYTHM.ADD.POW){if(!h.endsWith("~"+s)&&h!==s){document.cookie="score="+e[0]+"___"+(h?h+"~":"")+s+"; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":"");const t=h.split("~").pop();if(t&&t!==s){const i=this.get("rhythm_"+t);i&&(document.cookie="rhythm_"+t+"="+i+"___"+s+this.u)}}const t=this.get(window.name);if(t){const i=t.split("_").slice(8).join("_");if(i.match(/___\d+$/)){const t=this.v.l();let s=0;for(;i[s]===t[s];)s++;this.v.t=[i+t.slice(s).replace(/^\/+/,BEAT.TOK.T)]}}}const o=[0,this.data.time,this.data.key,this.data.device,this.data.referrer,this.data.p,this.data.S,Math.floor(Date.now()/RHYTHM.TIC)-this.data.time,this.v?.l()||""].join("_");document.cookie=this.data.name+"="+o+this.u,o.length>RHYTHM.CAP&&(document.cookie=this.data.name+"=1"+o.slice(1)+this.u,this.session(!0))}click(t){this.data||this.session(),this.data.S++,this.v.element(t),this.save();const i=this.get("score"),s=i?.split("_")[0],e=this.get("waf"),h=this.score?.split("_")[0];s&&s!==h&&(this.score=i,this.force=RHYTHM.TAP);const o=s?.[0],n=h?.[0];o&&o>="1"&&(!e||o>e)&&o!==n&&(document.cookie="waf="+o+"; Path=/",location.reload());for(let c=1;s&&c<10;c++)"1"===s[c]&&RHYTHM.HUM?.[c]?.(this);if(this.data.S%RHYTHM.TAP===0||this.force){const t=new AbortController;fetch(location.origin+("/"===RHYTHM.HIT?"":RHYTHM.HIT)+"/?livestreaming",{method:"HEAD",signal:t.signal,credentials:"include",redirect:"manual",keepalive:!0}).catch(()=>{}),this.data.S>RHYTHM.TAP&&!this.force&&setTimeout(()=>t.abort(),RHYTHM.THR),this.force&&this.force--}}k(){const t=this,i=history.pushState,s=history.replaceState;history.pushState=(s,e,h)=>{i.call(history,s,e,h),t.v.page(location.pathname),t.save()},history.replaceState=(i,e,h)=>{s.call(history,i,e,h),t.v.page(location.pathname),t.save()},window.addEventListener("popstate",()=>{t.v.page(location.pathname),t.save()})}}document.addEventListener("DOMContentLoaded",()=>new Rhythm);
