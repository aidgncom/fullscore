const BEAT={TIC:100,TOK:{P:"!",E:"*",T:"~",A:"/",L:"-"},MAP:{P:{},E:{}}};const RHYTHM={HIT:"/rhythm",ECO:["/rhythm/echo"],TIC:100,TAP:3,THR:1,KEY:8,AGE:259200,MAX:7,CAP:3500,DEL:1,REF:{}};class Beat{constructor(){this.t=[],this.table={},this.i={pages:{...BEAT.MAP.P},elements:{...BEAT.MAP.E}},this.h=Date.now()}time(){const t=Date.now(),i=(t-this.h)/BEAT.TIC|0;i>0&&(this.t.push(BEAT.TOK.T+i),this.h=t)}page(t){if(this.time(),this.i.pages[t])return this.t.push(BEAT.TOK.P+this.i.pages[t]);let i=5381;for(let c=0;t.length>c;c++)i=(i<<5)+i+t.charCodeAt(c);const s=t.length>7?t.length>14?5:4:3;let h="",e=Math.abs(i);for(let c=0;s>c;c++)h+="0123456789abcdefghijklmnopqrstuvwxyz"[e%36],e=Math.floor(e/36);let o=BEAT.TOK.P+h,n="";for(;this.table[o]&&this.table[o]!==t;)n+=BEAT.TOK.L,o=BEAT.TOK.P+n+h;this.table[o]=t,this.t.push(o)}o(t){const i=this.t.length;if(i>1&&this.t[i-1].startsWith(BEAT.TOK.T)){const s=this.t[i-1].substring(1),h=this.t[i-2];if(h.endsWith(t))return this.t[i-2]=h.substring(0,h.length-t.length)+BEAT.TOK.A+s+t,void this.t.pop()}this.t.push(t)}element(t){if(!t||3===t.nodeType&&!(t=t.parentElement))return;this.time();let i=t.id&&this.i.elements["#"+t.id]?"#"+t.id:null;!i&&"string"==typeof t.className&&t.className&&(i=t.className.trim().split(/\s+/).map(t=>"."+t).find(t=>this.i.elements[t]));const s=!i&&"A"===t.tagName&&t.href&&t.getAttribute("href");if(s&&this.i.elements[s]&&(i=s),i)return this.o(BEAT.TOK.E+this.i.elements[i]);let h=0,e=t;for(;e&&e!==document.body;)h++,e=e.parentElement;const o=t.tagName.toLowerCase();let n=1,c=t.previousElementSibling;for(;c;)c.tagName.toLowerCase()===o&&n++,c=c.previousElementSibling;const r=h+o+n;this.o(BEAT.TOK.E+(this.i.elements["*"+r]||r))}l(){return this.t.join("")}}class Rhythm{constructor(){if(this.m="; Path=/; Max-Age="+RHYTHM.AGE+"; SameSite=Lax"+("https:"===location.protocol?"; Secure":""),!this.get("score")){this.u(),this._();let t="";for(let s=0;RHYTHM.KEY>s;s++)t+="0123456789abcdefghijklmnopqrstuvwxyz"[36*Math.random()|0];const i=Math.floor(Date.now()/RHYTHM.TIC);document.cookie="score=0000000000_"+i+"_"+t+"___; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":"")}this.score=this.get("score");const t=this.score.split("_");this.time=+t[1],this.key=t[2],this.session(),document.addEventListener("click",t=>this.click(t.target),{capture:!0}),this.scrolling=!1,document.addEventListener("scroll",()=>{this.data||this.session(),this.scrolling||(this.scrolling=!0,this.data.p++,this.save()),clearTimeout(this.s),this.s=setTimeout(()=>{this.scrolling=!1},150)},{capture:!0,passive:!0}),document.addEventListener("visibilitychange",()=>{const t=this.get(window.name);if("hidden"===document.visibilityState){if(RHYTHM.DEL>0)for(let t=1;RHYTHM.MAX>=t;t++){const i="rhythm_"+t,s=this.get(i),h=s&&+(s.split("_",7)[6]||0)<RHYTHM.DEL;h&&(document.cookie=i+"=; Max-Age=0; Path=/"),h&&i===window.name&&(this.data=null,this.v=null,window.name="")}/mobi|android|tablet|ipad|iphone/i.test(navigator.userAgent)&&t&&"0"===t[0]&&(document.cookie=window.name+"=1"+t.slice(1)+this.m),setTimeout(()=>!/rhythm_\d+=0/.test(document.cookie)&&this.blur&&this._(),1)}else t&&"1"===t[0]&&(document.cookie=window.name+"=0"+t.slice(1)+this.m)});const i=()=>{const t=this.get(window.name);t&&"0"===t[0]&&(document.cookie=window.name+"=1"+t.slice(1)+this.m)};window.addEventListener("blur",()=>"hidden"===document.visibilityState&&(i(),this.blur=!0,setTimeout(()=>this.blur=!1,17))),window.addEventListener("pagehide",t=>!t.persisted&&(i(),setTimeout(()=>!/rhythm_\d+=0/.test(document.cookie)&&this._(),1)))}get(t){const i="; "+document.cookie+";",s=i.indexOf("; "+t+"=");return 0>s?null:i.slice(s+t.length+3,i.indexOf(";",s+t.length+3))}click(t){this.data||this.session(),this.data.k++,this.v.element(t),this.save();const i=this.get("score"),s=i?.split("_")[0],h=this.get("waf");s&&s!==this.score.split("_")[0]&&(this.score=i,this.force=RHYTHM.TAP),s&&s[0]>="1"&&(!h||s[0]>h)&&(document.cookie="waf="+s[0]+"; Path=/",location.replace(location.href));for(let e=1;s&&10>e;e++)"1"===s[e]&&RHYTHM.HUM?.[e](this);if(this.data.k%RHYTHM.TAP===0||this.force){const t=new AbortController;fetch(location.origin+("/"===RHYTHM.HIT?"":RHYTHM.HIT)+"/?livestreaming",{method:"HEAD",signal:t.signal,credentials:"include",redirect:"manual",keepalive:!0}).catch(()=>{}),this.data.k>RHYTHM.TAP&&!this.force&&setTimeout(()=>t.abort(),RHYTHM.THR),this.force&&this.force--}}u(){for(let t=1;RHYTHM.MAX>=t;t++){const i="rhythm_"+t;"2"===this.get(i)?.[0]&&(document.cookie=i+"=; Max-Age=0; Path=/")}this.data=null,this.v=null,window.name=""}_(){const t=document.cookie.match(/rhythm_\d+=[^;]*/g);if(t){const i=[];for(let h=0;t.length>h;h++){const s=t[h].replace(/=./,"=2");document.cookie=s+this.m,i.push(s)}const s=i.join("");for(const t of RHYTHM.ECO){const i="h"===t[0]?t:location.origin+t;navigator.sendBeacon(i,s)||fetch(i,{method:"POST",body:s,keepalive:!0}).catch(()=>{})}}this.u()}session(t=!1){if(!t&&window.name.startsWith("rhythm_")){const t=this.get(window.name);if(t){const i=t.split("_"),s=i.slice(8).join("_");return this.data={name:window.name,time:+i[1],key:i[2],device:+i[3],referrer:+i[4],p:+i[5],k:+i[6]},this.v=new Beat,s&&(this.v.t=[s],this.v.h=Date.now()),this.v.page(location.pathname),this.save()}window.name=""}let i=null;for(let n=1;RHYTHM.MAX>=n;n++)if(!this.get("rhythm_"+n)){i="rhythm_"+n;break}if(!i){this._(),this.data=null;const t=Math.floor(Date.now()/RHYTHM.TIC);document.cookie="score="+this.score.split("_")[0]+"_"+t+"_"+this.key+"___; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":""),this.time=t,i="rhythm_1"}window.name=i;const s=navigator.userAgent,h=document.referrer,e=h?.match(/^https?:\/\/([^\/]+)/)?.[1]||"";let o=h?e===location.hostname?1:2:0;if(2===o&&e)for(const n in RHYTHM.REF)if(e===n||e.endsWith("."+n)){o=RHYTHM.REF[n];break}this.data={name:i,time:this.time,key:this.key,device:/ipad|tablet|silk/i.test(s)||/android/i.test(s)&&!/mobi/i.test(s)?2:/mobi|iphone/i.test(s)?1:0,referrer:o,p:0,k:0},this.v=new Beat,this.v.page(location.pathname),this.save()}save(){const t=this.get("score")||this.score;if(+t.split("_",2)[1]!==+this.score.split("_",2)[1])return this.score=t,this.data=null,void this.session(!0);const i=window.name.slice(7),s=t.split("___"),h=s[1]||"";if(!h.endsWith("~"+i)&&h!==i){document.cookie="score="+s[0]+"___"+(h?h+"~":"")+i+"; Path=/; SameSite=Lax"+("https:"===location.protocol?"; Secure":"");const t=h.split("~").pop();if(t&&t!==i){const s=this.get("rhythm_"+t);s&&(document.cookie="rhythm_"+t+"="+s+"___"+i+this.m)}}const e=this.get(window.name);if(e){const t=e.split("_").slice(8).join("_");if(t.match(/___\d+$/)){const i=this.v.l();let s=0;for(;t[s]===i[s];)s++;this.v.t=[t+i.slice(s).replace(/^\/+/,BEAT.TOK.T)]}}const o=[0,this.data.time,this.data.key,this.data.device,this.data.referrer,this.data.p,this.data.k,Math.floor(Date.now()/RHYTHM.TIC)-this.data.time,this.v.l()||""].join("_");document.cookie=this.data.name+"="+o+this.m,o.length>RHYTHM.CAP&&(document.cookie=this.data.name+"=1"+o.slice(1)+this.m,this.session(!0))}}document.addEventListener("DOMContentLoaded",()=>new Rhythm);
